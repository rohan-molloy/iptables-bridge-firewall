*filter
:FORWARD DROP [0:0]
:INPUT DROP [0:0]
:OUTPUT ACCEPT [0:0]
#
#	Ensure DHCP can pass through
#
-A FORWARD --protocol udp --sport 68 --dport 67
-A FORWARD --protocol udp --sport 67 --dport 68
#
# 	The mac addresses in the below set have unrestricted outbound access
#
-A FORWARD --match set --match-set dmz_out_exempt src --match physdev --physdev-in $INSIDE_ETH --jump ACCEPT
#
#	Hosts that have previously communicated with malware C&C are blocked
#
-A FORWARD --match set --match-set dmz_infected src -j LOG
-A FORWARD --match set --match-set dmz_infected src -j REJECT --reject-with icmp-host-prohibited
#
#	If a host attempts to contact known malware servers, add it to above set
#
-A FORWARD --match set --match-set et_botcc dst --match physdev --physdev-in $INSIDE_ETH -j LOG
-A FORWARD --match set --match-set et_botcc dst --match physdev --physdev-in $INSIDE_ETH -j SET --add-set dmz_infected src
#
# 	Allow replies from wan; traffic must not be SYN  
#
-A FORWARD --protocol tcp --dport 1025:65535 ! --tcp-flags FIN,SYN,RST,ACK SYN --match physdev --physdev-in $OUTSIDE_ETH --jump ACCEPT
-A FORWARD --protocol udp --dport 1025:65535 --match physdev --physdev-in $OUTSIDE_ETH --jump ACCEPT
#
#	Allow destination-unreachable and other icmp messages
#
-A FORWARD --protocol icmp --icmp-type 3  --jump ACCEPT
-A FORWARD --protocol icmp --icmp-type 11 --jump ACCEPT
-A FORWARD --protocol icmp --icmp-type 12 --jump ACCEPT
#
#	Allow pings initiated from the inside
#
-A FORWARD --protocol icmp --icmp-type 8 --match physdev --physdev-in $INSIDE_ETH --jump ACCEPT
-A FORWARD --protocol icmp --icmp-type 0 --jump ACCEPT
#
#	Allow DMZ devices to connect to these locations
#
-A FORWARD --match set --match-set dmz_out dst,dst --match physdev --physdev-in $INSIDE_ETH --jump ACCEPT
-A FORWARD --match set --match-set dmz_out src,src --match physdev --physdev-in $OUTSIDE_ETH --jump ACCEPT
#
#	Expose the following endpoints to the enternet
#
-A FORWARD --match set --match-set dmz_endpoint dst,dst --match physdev --physdev-in $OUTSIDE_ETH --jump ACCEPT
-A FORWARD --match set --match-set dmz_endpoint src,src --match physdev --physdev-in $INSIDE_ETH --jump ACCEPT
#
# 	Standard Rules for the gateway itself
#
-A INPUT --match conntrack --ctstate RELATED,ESTABLISHED --jump ACCEPT
-A INPUT --in-interface lo --jump ACCEPT
-A INPUT --protocol icmp --icmp-type 8 --jump ACCEPT
-A INPUT --match conntrack --ctstate NEW -m set --match-set mgmt_from src,src -m set --match-set mgmt_endpoint dst,dst --jump ACCEPT
-A OUTPUT --out-interface lo --jump ACCEPT
-A OUTPUT --out-interface $BRIDGE --match set --match-set fw_out dst,dst --jump ACCEPT
COMMIT
